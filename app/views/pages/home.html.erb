<script type="text/javascript">
	$("document").ready( function() {
		xhr_get("<%= escape_javascript(topdayjson_path) %>");

		var shortText = $("#video-title").text()
		if (shortText.length > 45) {
			var shortText = $("#video-title").text().trim().substring(0,42)+"..."
		}
		else {
			var shortText = $("#video-title").text()
		}
		$("#video-title").html(shortText);
	})
</script>

<% if signed_in? %>
	<% if current_user.videos.first.nil? %>
		<%= render 'shared/search' %>
		<style>.right-container { margin-top: -136px; }</style> <!-- Ugly style fix. Address in redesign -->
	<% elsif (Time.now - current_user.videos.first.created_at.localtime) >= 84600 || current_user.videos.first.votes.count >=2 %>
		<%= render 'shared/search' %>
		<style>.right-container { margin-top: -136px; }</style> <!-- Ugly style fix. Address in redesign -->
	<% end %>

<div class="left-container">
	<% unless current_user.feed.empty? %>

		<script>
		  $(document).ready(function(){
		    pagelessHTML = "<%= escape_javascript(pageless(10, @path)) %>";
		    elemIds = {'feed': '#feed', 'recent': '#recent', 'day': '#day', 'week': '#week', 'month': '#month', 'alltime': '#alltime'};
		    loadSongs(elemIds, pagelessHTML, "<%= @feed_items.total_pages %>");
		  });
		</script>

		<div class="video-feed-header">Videos from your followers
			<%= link_to "Your feed", root_path, :remote => true, :id => 'feed' %>
			<%= link_to "Recent", videos_path, :remote => true, :id => 'recent' %>
			<%= link_to "Day", day_path, :remote => true, :id => 'day' %>
		    <%= link_to "Week", week_path, :remote => true, :id => 'week' %>
		    <%= link_to "Month", month_path, :remote => true, :id => 'month' %>
		    <%= link_to "All time", alltime_path, :remote => true, :id => 'alltime' %>
		    <a href="#">People</a>
		</div>
			<div id="results">
			  <%= render 'shared/feed' %> <!-- Render first count of feed items with render. Remaining are sent from controller
	                                       after Pageless requests asynchronously -->
		      <%= will_paginate @feed_items %> <!-- Keep to show pagination if JS is disabled. Requesting ?page=2 doesn't 
		                                            work though as 'sort' template doesn't render to prevent multiple template requests once Pageless fires.  -->
		      <%= pageless(@feed_items.total_pages, @path) %> <!-- First param is total number of pages sent back by will_paginate gem, which should descrease in count.
		                                                           Second param is path to request more data.   -->
			</div>
	<% else %>
		<div style="padding: 30px;font-size: 20px;">You're not following anyone. Check out some <%= link_to "suggested people", users_path %>.</div>
	<% end %>
</div>

<div class="right-container floatright" style="margin-left:0;">
	<% unless current_user.videos.first.nil? %>
		<div class="current-video-container">
			<div class="current-video-header">Your Current Video</div>
			<div class="current-video-image">
				<a href="<%= video_path(current_user.current_video.id) %>"><img src="http://i.ytimg.com/vi/<%= current_user.current_video.youtube_id %>/default.jpg" /></a>
			</div>
			<div class="current-video-title-and-time">
				<h3><a href="<%= video_path(current_user.current_video.id) %>" id="video-title"><%= current_user.current_video.title %></a></h3>
				<p><%= time_ago_in_words(current_user.current_video.created_at) %></p>
			</div>
			<ul class="current-video-points-comments unstyled">
				<li class="current-video-points"><%= current_user.current_video.votes_count %> points</li>
				<li class="current-video-comments"><%= current_user.current_video.comments.count %> comments</li>
			</ul>
			<div class="current-video-update"><%= link_to "Update video", edit_video_path(current_user.current_video) %></div>
		</div>
	<% end %>

	<div class="stats-container" style="height: 148px;">
		<div class="stats-header">Your Stats</div>
		<ul class="list-stats unstyled">
			<li class="list-points"><a href="<%= user_path(current_user) %>">
				<% if current_user.points == 0 %>
					0 total points
				<% else %>
					<%= current_user.points %> total points
				<% end %>
				</a></li>
			<li class="list-followers"><a href="<%= followers_user_path(current_user) %>"><%= current_user.followers.count %> followers</a></li>
			<li class="list-following"><a href="<%= following_user_path(current_user) %>"><%= current_user.following.count %> following</a></li>
		</ul>
	</div>
	<% unless current_user.authentications.count == 2 %>
		<div class="stats-container" style="height:100%; margin-top: 20px; ">
			<div>
				<p><i>Paint the Town is better social</i></p>
				<ul class="connect unstyled">
					<% unless current_user.has_facebook?.present? %>
						<li class="facebook"><a href="/auth/facebook">Connect to Facebook</a></li>
					<% end %>
					<% unless current_user.has_twitter?.present? %>
						<li class="twitter"><a href="/auth/twitter">Connect to Twitter</a></li>
					<% end %>
				</ul>
			</div>
		</div>
	<% end %>

	<div class="more-from-right-container" style="margin-top:20px;">
		<div class="more-from-user-container" id="items-trending">
			<div class="more-from-user-header">Trending</div>
			<div id="loading" style="margin:10px;"></div>

		</div>
	</div>
</div>

<% else %>
<!-- Hero Container -->
<div id="hero">
	<h1>The hit factory</h1>
	<h2>Share new music with friends. Get points.</h2>
	<%= link_to image_tag("sign-in-facebook.png", :alt => "Paint the Town"), '/auth/facebook' %>
</div>
<!-- End Hero Container -->
<div class="left-container">
	<div class="video-feed-header">Recent Videos</div>
	<div id="results">
		<%= render 'shared/feed' %>
		<%= will_paginate @feed_items %>
		<%= pageless(@feed_items.total_pages, root_path, "#results") %>
	</div>
</div>
<div class="right-container">
	<div class="stats-container" style="height: 100%;">
		<div class="stats-header">How's it work?</div>
		<div>
			<h3>Post a song</h3>
			<p>Share the song that you love with your followers</p>
			<h3>Get points</h3>
			<p>The community may give it points if it's not terrible</p>
			<h3>Post again if...</h3>
			<p>...your song receives two or more points or you wait 24 hours</p>
			<%= link_to "Get started now", signin_path %>
		</div>
	</div>
</div>

<% end %>